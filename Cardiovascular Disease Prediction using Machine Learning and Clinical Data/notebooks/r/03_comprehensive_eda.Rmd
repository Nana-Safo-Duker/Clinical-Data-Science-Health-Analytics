---
title: "Comprehensive Exploratory Data Analysis (EDA)"
author: "Cardiovascular Disease Analysis"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width = 14, fig.height = 8)
```

## Introduction

This notebook provides a comprehensive exploratory data analysis of the Cardiovascular Disease Dataset, including:
- Data Quality Assessment
- Missing Value Analysis
- Data Profiling
- Advanced Visualizations
- Pattern Recognition
- Outlier Analysis
- Data Distribution Analysis
- Feature Engineering Insights
- Summary and Recommendations

## Load Libraries and Data

```{r load-libraries}
# Load necessary libraries
library(tidyverse)
library(ggplot2)
library(dplyr)
library(corrplot)
library(VIM)
library(psych)
library(Hmisc)
library(car)
library(gridExtra)
library(ggcorrplot)

# Set theme for plots
theme_set(theme_minimal() + theme(plot.title = element_text(size = 14, face = "bold")))

# Load the dataset
df <- read.csv("../../data/Cardiovascular_Disease_Dataset.csv", stringsAsFactors = FALSE)

cat(paste(rep("=", 80), collapse = ""), "\n")
cat("COMPREHENSIVE EXPLORATORY DATA ANALYSIS\n")
cat(paste(rep("=", 80), collapse = ""), "\n")
cat("\nDataset loaded successfully!\n")
cat("Shape:", nrow(df), "rows,", ncol(df), "columns\n")
cat("Columns:", paste(names(df), collapse = ", "), "\n")
head(df)
```

## 1. Data Quality Assessment

```{r data-quality}
cat(paste(rep("=", 80), collapse = ""), "\n")
cat("DATA QUALITY ASSESSMENT\n")
cat(paste(rep("=", 80), collapse = ""), "\n")

# Basic information
cat("\n1. Dataset Dimensions:\n")
cat("   Rows:", nrow(df), "\n")
cat("   Columns:", ncol(df), "\n")
cat("   Memory usage:", format(object.size(df), units = "MB"), "\n")

# Data types
cat("\n2. Data Types:\n")
str(df)

# Missing values
cat("\n3. Missing Values Analysis:\n")
missing_data <- colSums(is.na(df))
missing_percent <- (missing_data / nrow(df)) * 100
missing_df <- data.frame(
  Column = names(missing_data),
  MissingCount = missing_data,
  MissingPercentage = missing_percent
)
missing_df <- missing_df[missing_df$MissingCount > 0, ]
if (nrow(missing_df) == 0) {
  cat("   ✓ No missing values found in the dataset!\n")
} else {
  print(missing_df)
}

# Duplicate records
cat("\n4. Duplicate Records:\n")
duplicates <- sum(duplicated(df))
cat("   Duplicate rows:", duplicates, "\n")
if (duplicates == 0) {
  cat("   ✓ No duplicate records found!\n")
} else {
  cat("   Percentage:", round((duplicates/nrow(df))*100, 2), "%\n")
}

# Unique values per column
cat("\n5. Unique Values per Column:\n")
for (col in names(df)) {
  cat("   ", col, ":", length(unique(df[[col]])), "unique values\n")
}
```

## 2. Data Profiling and Summary Statistics

```{r data-profiling}
cat(paste(rep("=", 80), collapse = ""), "\n")
cat("COMPREHENSIVE SUMMARY STATISTICS\n")
cat(paste(rep("=", 80), collapse = ""), "\n")

numerical_cols <- c("age", "restingBP", "serumcholestrol", "maxheartrate", "oldpeak")
cat("\nNumerical Variables Summary:\n")
print(summary(df[numerical_cols]))

cat("\n\nCategorical Variables Summary:\n")
categorical_cols <- c("gender", "chestpain", "fastingbloodsugar", "restingrelectro", 
                     "exerciseangia", "slope", "noofmajorvessels", "target")
for (col in categorical_cols) {
  if (col %in% names(df)) {
    cat("\n", toupper(col), ":\n")
    value_counts <- table(df[[col]])
    print(value_counts)
    cat("Percentage distribution:\n")
    for (val in names(value_counts)) {
      cat("  ", val, ":", value_counts[val], "(", round(value_counts[val]/nrow(df)*100, 2), "%)\n")
    }
  }
}
```

## 3. Target Variable Analysis

```{r target-analysis}
cat(paste(rep("=", 80), collapse = ""), "\n")
cat("TARGET VARIABLE ANALYSIS\n")
cat(paste(rep("=", 80), collapse = ""), "\n")

target_counts <- table(df$target)
target_percent <- prop.table(target_counts) * 100

cat("\nTarget Distribution:\n")
cat("  No Disease (0):", target_counts["0"], "(", round(target_percent["0"], 2), "%)\n")
cat("  Disease (1):", target_counts["1"], "(", round(target_percent["1"], 2), "%)\n")
cat("  Balance ratio:", round(min(target_counts)/max(target_counts), 3), "\n")

# Visualize target distribution
p1 <- ggplot(df, aes(x = factor(target), fill = factor(target))) +
  geom_bar(alpha = 0.8, color = "black") +
  scale_fill_manual(values = c("skyblue", "coral"), labels = c("No Disease", "Disease")) +
  labs(title = "Target Variable Distribution",
       x = "Target",
       y = "Count",
       fill = "Target") +
  theme_minimal() +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5, size = 5, fontface = "bold")

p2 <- ggplot(df, aes(x = "", fill = factor(target))) +
  geom_bar(width = 1) +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = c("skyblue", "coral"), labels = c("No Disease", "Disease")) +
  labs(title = "Target Variable Distribution (Percentage)",
       fill = "Target") +
  theme_void() +
  theme(legend.position = "right")

grid.arrange(p1, p2, ncol = 2)

cat("\n✓ Dataset is", ifelse(abs(target_percent["0"] - target_percent["1"]) < 10, "balanced", "imbalanced"), "\n")
```

## 4. Distribution Analysis

```{r distribution-analysis}
numerical_cols <- c("age", "restingBP", "serumcholestrol", "maxheartrate", "oldpeak")

plots_list <- list()
for (idx in 1:length(numerical_cols)) {
  col <- numerical_cols[idx]
  if (col %in% names(df)) {
    # Histogram with density
    p1 <- ggplot(df, aes_string(x = col)) +
      geom_histogram(aes(y = ..density..), bins = 30, fill = "steelblue", alpha = 0.7, color = "black") +
      geom_density(color = "red", size = 1) +
      geom_vline(aes_string(xintercept = mean(df[[col]], na.rm = TRUE)), 
                 color = "green", linetype = "dashed", size = 1) +
      geom_vline(aes_string(xintercept = median(df[[col]], na.rm = TRUE)), 
                 color = "orange", linetype = "dashed", size = 1) +
      labs(title = paste("Distribution of", col),
           x = col,
           y = "Density") +
      theme_minimal()
    
    # Box plot
    p2 <- ggplot(df, aes_string(y = col)) +
      geom_boxplot(fill = "lightblue", alpha = 0.7) +
      labs(title = paste("Box Plot of", col),
           y = col) +
      theme_minimal() +
      annotate("text", x = 1.2, y = median(df[[col]], na.rm = TRUE),
               label = paste0("Mean: ", round(mean(df[[col]], na.rm = TRUE), 2), "\n",
                             "Median: ", round(median(df[[col]], na.rm = TRUE), 2), "\n",
                             "Std: ", round(sd(df[[col]], na.rm = TRUE), 2), "\n",
                             "Skew: ", round(psych::skew(df[[col]], na.rm = TRUE), 2)),
               hjust = 0, vjust = 0.5, size = 3,
               bg = "wheat", alpha = 0.5)
    
    plots_list[[paste0(col, "_hist")]] <- p1
    plots_list[[paste0(col, "_box")]] <- p2
  }
}

# Display plots in a grid
do.call(grid.arrange, c(plots_list, ncol = 2))
```

## 5. Outlier Analysis

```{r outlier-analysis}
cat(paste(rep("=", 80), collapse = ""), "\n")
cat("OUTLIER ANALYSIS\n")
cat(paste(rep("=", 80), collapse = ""), "\n")

numerical_cols <- c("age", "restingBP", "serumcholestrol", "maxheartrate", "oldpeak")

# IQR method
cat("\n1. Outliers using IQR Method (Q1 - 1.5*IQR, Q3 + 1.5*IQR):\n")
outlier_summary <- data.frame(
  Variable = character(),
  LowerBound = numeric(),
  UpperBound = numeric(),
  OutlierCount = integer(),
  OutlierPercentage = numeric(),
  stringsAsFactors = FALSE
)

for (col in numerical_cols) {
  if (col %in% names(df)) {
    Q1 <- quantile(df[[col]], 0.25, na.rm = TRUE)
    Q3 <- quantile(df[[col]], 0.75, na.rm = TRUE)
    IQR_val <- Q3 - Q1
    lower_bound <- Q1 - 1.5 * IQR_val
    upper_bound <- Q3 + 1.5 * IQR_val
    outliers <- df[df[[col]] < lower_bound | df[[col]] > upper_bound, ]
    outlier_count <- nrow(outliers)
    outlier_percent <- (outlier_count / nrow(df)) * 100
    
    outlier_summary <- rbind(outlier_summary, data.frame(
      Variable = col,
      LowerBound = lower_bound,
      UpperBound = upper_bound,
      OutlierCount = outlier_count,
      OutlierPercentage = outlier_percent
    ))
    
    cat("\n", col, ":\n")
    cat("  Q1:", Q1, ", Q3:", Q3, ", IQR:", IQR_val, "\n")
    cat("  Lower bound:", lower_bound, ", Upper bound:", upper_bound, "\n")
    cat("  Outliers:", outlier_count, "(", round(outlier_percent, 2), "%)\n")
  }
}

cat("\n\nOutlier Summary Table:\n")
print(outlier_summary)

# Z-score method
cat("\n\n2. Outliers using Z-Score Method (|Z| > 3):\n")
for (col in numerical_cols) {
  if (col %in% names(df)) {
    z_scores <- abs(scale(df[[col]]))
    outliers_z <- sum(z_scores > 3, na.rm = TRUE)
    outlier_percent_z <- (outliers_z / sum(!is.na(df[[col]]))) * 100
    cat("  ", col, ":", outliers_z, "outliers (", round(outlier_percent_z, 2), "%)\n")
  }
}
```

## 6. Correlation Analysis

```{r correlation-analysis}
numerical_cols_with_target <- c("age", "restingBP", "serumcholestrol", "maxheartrate", "oldpeak", "target")
correlation_matrix <- cor(df[numerical_cols_with_target], use = "complete.obs")

# Correlation heatmap
ggcorrplot(correlation_matrix, method = "circle", type = "upper",
           colors = c("blue", "white", "red"),
           lab = TRUE, lab_size = 3,
           title = "Correlation Matrix Heatmap")

# Correlation with target
cat(paste(rep("=", 80), collapse = ""), "\n")
cat("CORRELATION WITH TARGET VARIABLE\n")
cat(paste(rep("=", 80), collapse = ""), "\n")

target_corr <- correlation_matrix[, "target"]
target_corr <- target_corr[names(target_corr) != "target"]
target_corr <- sort(target_corr, decreasing = TRUE)

cat("\nCorrelation with Target (sorted by absolute value):\n")
for (var in names(target_corr)) {
  cat("  ", var, ":", round(target_corr[var], 4), "\n")
}

# Visualize correlations with target
target_corr_df <- data.frame(
  Feature = names(target_corr),
  Correlation = as.numeric(target_corr)
)
target_corr_df <- target_corr_df[order(abs(target_corr_df$Correlation), decreasing = TRUE), ]

ggplot(target_corr_df, aes(x = reorder(Feature, abs(Correlation)), y = Correlation, 
                           fill = ifelse(Correlation < 0, "Negative", "Positive"))) +
  geom_bar(stat = "identity", alpha = 0.7) +
  scale_fill_manual(values = c("Negative" = "red", "Positive" = "green")) +
  coord_flip() +
  labs(title = "Correlation of Features with Target Variable",
       x = "Feature",
       y = "Correlation Coefficient",
       fill = "Correlation") +
  theme_minimal() +
  geom_hline(yintercept = 0, color = "black", linetype = "solid", size = 0.8)
```

## 7. Relationship Analysis: Features vs Target

```{r relationship-analysis}
numerical_cols <- c("age", "restingBP", "serumcholestrol", "maxheartrate", "oldpeak")

plots_list <- list()
for (col in numerical_cols) {
  if (col %in% names(df)) {
    p <- ggplot(df, aes_string(x = "factor(target)", y = col, fill = "factor(target)")) +
      geom_violin(alpha = 0.7) +
      geom_boxplot(width = 0.1, fill = "white", alpha = 0.5) +
      scale_fill_manual(values = c("skyblue", "coral"), labels = c("No Disease", "Disease")) +
      labs(title = paste(col, "by Target"),
           x = "Target",
           y = col,
           fill = "Target") +
      theme_minimal() +
      theme(legend.position = "none") +
      scale_x_discrete(labels = c("No Disease", "Disease"))
    
    # Add mean values
    mean_0 <- mean(df[df$target == 0, col], na.rm = TRUE)
    mean_1 <- mean(df[df$target == 1, col], na.rm = TRUE)
    p <- p + annotate("text", x = 1, y = mean_0, label = paste0("M=", round(mean_0, 1)),
                     hjust = 0.5, vjust = -0.5, size = 3, bg = "white", alpha = 0.8) +
      annotate("text", x = 2, y = mean_1, label = paste0("M=", round(mean_1, 1)),
               hjust = 0.5, vjust = -0.5, size = 3, bg = "white", alpha = 0.8)
    
    plots_list[[col]] <- p
  }
}

do.call(grid.arrange, c(plots_list, ncol = 2))
```

## 8. Feature Engineering Insights

```{r feature-engineering}
cat(paste(rep("=", 80), collapse = ""), "\n")
cat("FEATURE ENGINEERING INSIGHTS\n")
cat(paste(rep("=", 80), collapse = ""), "\n")

# Age groups
df$age_group <- cut(df$age, breaks = c(0, 40, 50, 60, 70, 100), 
                    labels = c("<40", "40-50", "50-60", "60-70", "70+"))
cat("\n1. Age Groups Distribution:\n")
age_group_target <- prop.table(table(df$age_group, df$target), margin = 1) * 100
print(round(age_group_target, 2))
cat("\nDisease rate by age group:\n")
print(round(aggregate(target ~ age_group, data = df, FUN = function(x) mean(x) * 100), 2))

# BP categories
df$bp_category <- cut(df$restingBP, breaks = c(0, 90, 120, 140, 200), 
                     labels = c("Low", "Normal", "Elevated", "High"))
cat("\n\n2. Blood Pressure Categories:\n")
bp_target <- prop.table(table(df$bp_category, df$target), margin = 1) * 100
print(round(bp_target, 2))

# Heart rate zones
df$hr_zone <- cut(df$maxheartrate, breaks = c(0, 100, 130, 160, 220), 
                 labels = c("Low", "Moderate", "High", "Very High"))
cat("\n\n3. Heart Rate Zones:\n")
hr_target <- prop.table(table(df$hr_zone, df$target), margin = 1) * 100
print(round(hr_target, 2))

# Risk score
df$risk_score <- (df$age / 10) + (df$restingBP / 20) + (df$oldpeak * 2) - (df$maxheartrate / 10)
cat("\n\n4. Risk Score Statistics:\n")
print(aggregate(risk_score ~ target, data = df, FUN = summary))
```

## 9. Summary and Recommendations

```{r summary}
cat(paste(rep("=", 80), collapse = ""), "\n")
cat("COMPREHENSIVE EDA SUMMARY AND RECOMMENDATIONS\n")
cat(paste(rep("=", 80), collapse = ""), "\n")

cat("
## Key Findings:

### 1. Data Quality:
   - Dataset contains", nrow(df), "records with", ncol(df), "features
   - No missing values detected
   - No duplicate records found
   - Data appears to be clean and ready for analysis

### 2. Target Variable:
   - Target distribution:", round(target_percent["0"], 2), "% /", round(target_percent["1"], 2), "%
   - Dataset is", ifelse(abs(target_percent["0"] - target_percent["1"]) < 10, "balanced", "imbalanced"), "
   - This affects model selection and evaluation strategies

### 3. Key Features:
   - Age, restingBP, maxheartrate, and oldpeak show significant relationships with target
   - Categorical features like chestpain, exerciseangia, and slope are important predictors
   - Correlation analysis reveals which features are most predictive

### 4. Outliers:
   - Some outliers detected in numerical variables
   - Consider outlier treatment strategies based on domain knowledge
   - Evaluate impact of outliers on model performance

### 5. Feature Engineering Opportunities:
   - Age groups can capture non-linear relationships
   - Blood pressure and heart rate categories may improve model performance
   - Risk score combinations could be valuable
   - Interaction terms between features might be beneficial

## Recommendations:

### 1. Preprocessing:
   - Scale numerical features for distance-based algorithms
   - Encode categorical variables appropriately
   - Consider outlier treatment if they represent errors

### 2. Feature Selection:
   - Focus on features with high correlation with target
   - Consider feature importance from tree-based models
   - Evaluate feature interactions

### 3. Model Selection:
   - Try tree-based models (Random Forest, XGBoost, LightGBM) for non-linear relationships
   - Use logistic regression as baseline
   - Consider ensemble methods for better performance

### 4. Evaluation:
   - Use appropriate metrics based on class distribution
   - Consider cross-validation for robust evaluation
   - Monitor for overfitting

### 5. Next Steps:
   - Proceed with machine learning model development
   - Implement feature engineering based on insights
   - Perform hyperparameter tuning
   - Evaluate model interpretability
")
```
