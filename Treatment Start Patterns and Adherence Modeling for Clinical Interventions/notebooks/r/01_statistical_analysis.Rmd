---
title: "Statistical Analysis: Descriptive, Inferential, and Exploratory"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Objectives
- Descriptive Statistics: Summary statistics, distributions, central tendencies
- Inferential Statistics: Hypothesis testing, confidence intervals
- Exploratory Statistics: Data patterns, relationships, anomalies

```{r load-libraries}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)
library(corrplot)
library(car)
```

```{r load-data}
# Load data
df <- read.csv("../../data/mock_treatment_starts_2016.csv", stringsAsFactors = FALSE)

# Preprocess data
df$TreatmentStart <- as.Date(df$TreatmentStart, format = "%m/%d/%y")
df$Year <- year(df$TreatmentStart)
df$Month <- month(df$TreatmentStart)
df$Day <- day(df$TreatmentStart)
df$MonthName <- month.name[df$Month]
df$Weekday <- weekdays(df$TreatmentStart)

# Display basic info
cat("Dataset shape:", dim(df), "\n")
head(df)
```

## 1. Descriptive Statistics

```{r descriptive-stats}
# Descriptive statistics for numerical variables
cat("=" %+% rep("=", 59), "\n")
cat("DESCRIPTIVE STATISTICS - DOSAGE\n")
cat("=" %+% rep("=", 59), "\n")
summary(df$Dosage)

cat("\nSummary by Drug:\n")
df %>% 
  group_by(Drug) %>% 
  summarise(
    Mean = mean(Dosage),
    Median = median(Dosage),
    SD = sd(Dosage),
    Min = min(Dosage),
    Max = max(Dosage),
    Count = n()
  )
```

```{r central-tendency}
# Measures of central tendency and dispersion
cat("Measures of Central Tendency - Dosage\n")
cat(rep("-", 40), "\n")
cat("Mean:", mean(df$Dosage), "\n")
cat("Median:", median(df$Dosage), "\n")
cat("Mode:", names(sort(table(df$Dosage), decreasing = TRUE))[1], "\n")

cat("\nMeasures of Dispersion\n")
cat(rep("-", 40), "\n")
cat("Standard Deviation:", sd(df$Dosage), "\n")
cat("Variance:", var(df$Dosage), "\n")
cat("Range:", max(df$Dosage) - min(df$Dosage), "\n")
cat("IQR:", IQR(df$Dosage), "\n")
cat("CV:", (sd(df$Dosage) / mean(df$Dosage)) * 100, "%\n")
```

```{r shape-stats}
# Skewness and Kurtosis
library(moments)
cat("Shape Statistics - Dosage\n")
cat(rep("-", 40), "\n")
cat("Skewness:", skewness(df$Dosage), "\n")
cat("Kurtosis:", kurtosis(df$Dosage), "\n")
```

```{r categorical-stats}
# Categorical descriptive statistics
cat("=" %+% rep("=", 59), "\n")
cat("DESCRIPTIVE STATISTICS - CATEGORICAL VARIABLES\n")
cat("=" %+% rep("=", 59), "\n")

cat("\nDrug Distribution:\n")
table(df$Drug)
cat("\nProportions:\n")
prop.table(table(df$Drug)) * 100

cat("\nTreatment Starts by Month:\n")
table(df$MonthName)
```

## 2. Inferential Statistics

```{r normality-tests}
# Test for normality
cisplatin_dosage <- df$Dosage[df$Drug == "Cisplatin"]
nivolumab_dosage <- df$Dosage[df$Drug == "Nivolumab"]

cat("=" %+% rep("=", 59), "\n")
cat("NORMALITY TESTS\n")
cat("=" %+% rep("=", 59), "\n")

# Shapiro-Wilk test
if (length(cisplatin_dosage) <= 50) {
  shapiro_cis <- shapiro.test(cisplatin_dosage)
  cat("\nCisplatin - Shapiro-Wilk Test:\n")
  cat("  Statistic:", shapiro_cis$statistic, ", p-value:", shapiro_cis$p.value, "\n")
  cat("  Normal:", ifelse(shapiro_cis$p.value > 0.05, "Yes", "No"), "\n")
}

if (length(nivolumab_dosage) <= 50) {
  shapiro_niv <- shapiro.test(nivolumab_dosage)
  cat("\nNivolumab - Shapiro-Wilk Test:\n")
  cat("  Statistic:", shapiro_niv$statistic, ", p-value:", shapiro_niv$p.value, "\n")
  cat("  Normal:", ifelse(shapiro_niv$p.value > 0.05, "Yes", "No"), "\n")
}
```

```{r hypothesis-testing}
# Hypothesis Testing: Compare mean dosages between drugs
cat("=" %+% rep("=", 59), "\n")
cat("HYPOTHESIS TESTING: COMPARING DOSAGE MEANS\n")
cat("=" %+% rep("=", 59), "\n")

# T-test
t_test <- t.test(cisplatin_dosage, nivolumab_dosage, var.equal = FALSE)
cat("\nIndependent t-test (Welch's):\n")
cat("  t-statistic:", t_test$statistic, "\n")
cat("  p-value:", t_test$p.value, "\n")
cat("  Significant difference:", ifelse(t_test$p.value < 0.05, "Yes", "No"), "(α=0.05)\n")

# Mann-Whitney U test
mw_test <- wilcox.test(cisplatin_dosage, nivolumab_dosage, alternative = "two.sided")
cat("\nMann-Whitney U test (non-parametric):\n")
cat("  W-statistic:", mw_test$statistic, "\n")
cat("  p-value:", mw_test$p.value, "\n")
cat("  Significant difference:", ifelse(mw_test$p.value < 0.05, "Yes", "No"), "(α=0.05)\n")
```

```{r confidence-intervals}
# Confidence Intervals
cat("=" %+% rep("=", 59), "\n")
cat("CONFIDENCE INTERVALS (95%)\n")
cat("=" %+% rep("=", 59), "\n")

# For Cisplatin
cis_mean <- mean(cisplatin_dosage)
cis_sd <- sd(cisplatin_dosage)
cis_n <- length(cisplatin_dosage)
cis_se <- cis_sd / sqrt(cis_n)
cis_ci <- t.test(cisplatin_dosage)$conf.int
cat("\nCisplatin Mean Dosage:\n")
cat("  Mean:", cis_mean, "\n")
cat("  95% CI: [", cis_ci[1], ",", cis_ci[2], "]\n")

# For Nivolumab
niv_mean <- mean(nivolumab_dosage)
niv_sd <- sd(nivolumab_dosage)
niv_n <- length(nivolumab_dosage)
niv_se <- niv_sd / sqrt(niv_n)
niv_ci <- t.test(nivolumab_dosage)$conf.int
cat("\nNivolumab Mean Dosage:\n")
cat("  Mean:", niv_mean, "\n")
cat("  95% CI: [", niv_ci[1], ",", niv_ci[2], "]\n")
```

## 3. Exploratory Statistics

```{r outlier-detection}
# Exploratory: Detect outliers using IQR method
Q1 <- quantile(df$Dosage, 0.25)
Q3 <- quantile(df$Dosage, 0.75)
IQR_val <- IQR(df$Dosage)
lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val

outliers <- df[df$Dosage < lower_bound | df$Dosage > upper_bound, ]
cat("=" %+% rep("=", 59), "\n")
cat("OUTLIER DETECTION (IQR Method)\n")
cat("=" %+% rep("=", 59), "\n")
cat("Lower bound:", lower_bound, "\n")
cat("Upper bound:", upper_bound, "\n")
cat("\nNumber of outliers:", nrow(outliers), "\n")
if (nrow(outliers) > 0) {
  cat("\nOutliers:\n")
  print(outliers[, c("PatientID", "Drug", "Dosage")])
}
```

```{r temporal-patterns}
# Exploratory: Temporal patterns
cat("=" %+% rep("=", 59), "\n")
cat("TEMPORAL PATTERNS\n")
cat("=" %+% rep("=", 59), "\n")

cat("\nTreatment starts by month:\n")
monthly_counts <- df %>% 
  group_by(MonthName) %>% 
  summarise(Count = n()) %>% 
  arrange(match(MonthName, month.name))
print(monthly_counts)

cat("\nAverage dosage by month:\n")
monthly_dosage <- df %>% 
  group_by(MonthName) %>% 
  summarise(Mean_Dosage = mean(Dosage)) %>% 
  arrange(match(MonthName, month.name))
print(monthly_dosage)
```

```{r visualizations}
# Visualizations for exploratory statistics
library(gridExtra)

# 1. Distribution of Dosage
p1 <- ggplot(df, aes(x = Dosage)) +
  geom_histogram(bins = 15, fill = "steelblue", alpha = 0.7, color = "black") +
  geom_vline(aes(xintercept = mean(Dosage)), color = "red", linetype = "dashed") +
  geom_vline(aes(xintercept = median(Dosage)), color = "green", linetype = "dashed") +
  labs(title = "Distribution of Dosage", x = "Dosage", y = "Frequency") +
  theme_minimal()

# 2. Box plot by Drug
p2 <- ggplot(df, aes(x = Drug, y = Dosage)) +
  geom_boxplot() +
  labs(title = "Dosage Distribution by Drug", x = "Drug", y = "Dosage") +
  theme_minimal()

# 3. Treatment starts over time
monthly_counts_df <- df %>% 
  group_by(MonthName) %>% 
  summarise(Count = n()) %>% 
  arrange(match(MonthName, month.name))

p3 <- ggplot(monthly_counts_df, aes(x = MonthName, y = Count)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Treatment Starts by Month", x = "Month", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 4. Q-Q plot for normality check
p4 <- ggplot(df, aes(sample = Dosage)) +
  stat_qq() +
  stat_qq_line() +
  labs(title = "Q-Q Plot: Dosage Normality Check", x = "Theoretical Quantiles", y = "Sample Quantiles") +
  theme_minimal()

grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)
```

```{r helper-function}
# Helper function for string concatenation
`%+%` <- function(a, b) paste0(a, b)
```


